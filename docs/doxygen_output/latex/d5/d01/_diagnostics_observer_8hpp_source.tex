\hypertarget{_diagnostics_observer_8hpp_source}{}\doxysection{Diagnostics\+Observer.\+hpp}
\label{_diagnostics_observer_8hpp_source}\index{CompactStar/Physics/Evolution/Observers/DiagnosticsObserver.hpp@{CompactStar/Physics/Evolution/Observers/DiagnosticsObserver.hpp}}
\mbox{\hyperlink{_diagnostics_observer_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{2 \textcolor{comment}{// -\/*-\/ lsst-\/c++ -\/*-\/}}
\DoxyCodeLine{3 \textcolor{comment}{/*}}
\DoxyCodeLine{4 \textcolor{comment}{ * CompactStar}}
\DoxyCodeLine{5 \textcolor{comment}{ * See License file at the top of the source tree.}}
\DoxyCodeLine{6 \textcolor{comment}{ *}}
\DoxyCodeLine{7 \textcolor{comment}{ * Copyright (c) 2025}}
\DoxyCodeLine{8 \textcolor{comment}{ * Mohammadreza Zakeri}}
\DoxyCodeLine{9 \textcolor{comment}{ *}}
\DoxyCodeLine{10 \textcolor{comment}{ * MIT License â€” see LICENSE at repo root.}}
\DoxyCodeLine{11 \textcolor{comment}{ */}}
\DoxyCodeLine{12 }
\DoxyCodeLine{32 \textcolor{preprocessor}{\#include <cstddef>}}
\DoxyCodeLine{33 \textcolor{preprocessor}{\#include <fstream>}}
\DoxyCodeLine{34 \textcolor{preprocessor}{\#include <memory>}}
\DoxyCodeLine{35 \textcolor{preprocessor}{\#include <string>}}
\DoxyCodeLine{36 \textcolor{preprocessor}{\#include <unordered\_map>}}
\DoxyCodeLine{37 \textcolor{preprocessor}{\#include <unordered\_set>}}
\DoxyCodeLine{38 \textcolor{preprocessor}{\#include <vector>}}
\DoxyCodeLine{39 }
\DoxyCodeLine{40 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_driver_diagnostics_8hpp}{CompactStar/Physics/Driver/Diagnostics/DriverDiagnostics.hpp}}"{}}}
\DoxyCodeLine{41 \textcolor{preprocessor}{\#include "{}CompactStar/Physics/Evolution/Diagnostics/DiagnosticCatalog.hpp"{}}}
\DoxyCodeLine{42 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_diagnostic_packet_8hpp}{CompactStar/Physics/Evolution/Diagnostics/DiagnosticPacket.hpp}}"{}}}
\DoxyCodeLine{43 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_diagnostics_catalog_json_8hpp}{CompactStar/Physics/Evolution/Diagnostics/DiagnosticsCatalogJson.hpp}}"{}}}
\DoxyCodeLine{44 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_diagnostics_json_8hpp}{CompactStar/Physics/Evolution/Diagnostics/DiagnosticsJson.hpp}}"{}}}
\DoxyCodeLine{45 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_unit_contract_8hpp}{CompactStar/Physics/Evolution/Diagnostics/UnitContract.hpp}}"{}}}
\DoxyCodeLine{46 }
\DoxyCodeLine{47 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_i_observer_8hpp}{CompactStar/Physics/Evolution/Observers/IObserver.hpp}}"{}}}
\DoxyCodeLine{48 }
\DoxyCodeLine{49 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{_directory_8hpp}{Zaki/String/Directory.hpp}}"{}}}
\DoxyCodeLine{50 }
\DoxyCodeLine{51 \textcolor{keyword}{namespace }CompactStar::Physics::Evolution::Observers}
\DoxyCodeLine{52 \{}
\DoxyCodeLine{53 }
\DoxyCodeLine{57 \textcolor{keyword}{class }\mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer}{DiagnosticsObserver}} final : \textcolor{keyword}{public} \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_i_observer}{IObserver}}}
\DoxyCodeLine{58 \{}
\DoxyCodeLine{59   \textcolor{keyword}{public}:}
\DoxyCodeLine{63     \textcolor{keyword}{struct }\mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options}{Options}}}
\DoxyCodeLine{64     \{}
\DoxyCodeLine{66         \mbox{\hyperlink{class_zaki_1_1_string_1_1_directory}{Zaki::String::Directory}} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_af8515685b4edcf85068c17baa52b1d95}{output\_path}} = \textcolor{stringliteral}{"{}diagnostics.jsonl"{}};}
\DoxyCodeLine{67 }
\DoxyCodeLine{69         std::size\_t \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_afb79e6c765625695adeaec2c9f35baa3}{record\_every\_n\_steps}} = 0;}
\DoxyCodeLine{70 }
\DoxyCodeLine{72         \textcolor{keywordtype}{double} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_a743512ee27120462a873ffe047a911d1}{record\_every\_dt}} = 0.0;}
\DoxyCodeLine{73 }
\DoxyCodeLine{75         \textcolor{keywordtype}{bool} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_a0d8e613dd7e970e92bfc6d0fa57f3dd6}{record\_at\_start}} = \textcolor{keyword}{true};}
\DoxyCodeLine{76 }
\DoxyCodeLine{78         \textcolor{keywordtype}{bool} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_ada60d206d3f872d91fc75dd29c3b845c}{append}} = \textcolor{keyword}{false};}
\DoxyCodeLine{79 }
\DoxyCodeLine{81         \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_diagnostics_1_1_json_options}{Diagnostics::JsonOptions}} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_aa56b0db6f6e7eac41c39f9622977a4e2}{json\_opts}};}
\DoxyCodeLine{82 }
\DoxyCodeLine{84         \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_diagnostics_1_1_unit_vocabulary}{Diagnostics::UnitVocabulary}} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_a33c63f88767aec623626ecfecb7ce3a6}{unit\_vocab}};}
\DoxyCodeLine{85 }
\DoxyCodeLine{87         \textcolor{keywordtype}{double} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_a1ebafba05ae9db77db94269de4ffa944}{on\_change\_atol}} = 0.0;}
\DoxyCodeLine{88 }
\DoxyCodeLine{90         \textcolor{keywordtype}{double} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_a181c2e4b598a3d6c31a20b8bdbd40325}{on\_change\_rtol}} = 1e-\/12;}
\DoxyCodeLine{91 }
\DoxyCodeLine{93         \textcolor{keywordtype}{bool} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_a23ec547f96a44504f76eb39d45d939be}{write\_catalog}} = \textcolor{keyword}{true};}
\DoxyCodeLine{94 }
\DoxyCodeLine{96         \mbox{\hyperlink{class_zaki_1_1_string_1_1_directory}{Zaki::String::Directory}} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options_aa10541de22f705582f54b4338b97a1be}{catalog\_output\_path}} = \textcolor{stringliteral}{"{}"{}};}
\DoxyCodeLine{97     \};}
\DoxyCodeLine{98 }
\DoxyCodeLine{100     \textcolor{keyword}{explicit} \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer}{DiagnosticsObserver}}(\textcolor{keyword}{const} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options}{Options}} \&opts);}
\DoxyCodeLine{101 }
\DoxyCodeLine{103     \textcolor{keyword}{explicit} \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer}{DiagnosticsObserver}}(\mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options}{Options}} \&\&opts);}
\DoxyCodeLine{104 }
\DoxyCodeLine{111     \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer}{DiagnosticsObserver}}(\mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options}{Options}} opts,}
\DoxyCodeLine{112                         std::vector<const Driver::Diagnostics::IDriverDiagnostics *> drivers);}
\DoxyCodeLine{113 }
\DoxyCodeLine{114     \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_a6c0d09976ddf5d4f4d2f87b035e07b96}{\string~DiagnosticsObserver}}() \textcolor{keyword}{override};}
\DoxyCodeLine{115 }
\DoxyCodeLine{119     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_a11c39761b8722bc0062df685ef78d1c9}{OnSample}}(\textcolor{keyword}{const} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_sample_info}{SampleInfo}} \&s,}
\DoxyCodeLine{120                   \textcolor{keyword}{const} \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_state_vector}{StateVector}} \&Y,}
\DoxyCodeLine{121                   \textcolor{keyword}{const} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_driver_context}{DriverContext}} \&ctx) \textcolor{keyword}{override};}
\DoxyCodeLine{122 }
\DoxyCodeLine{130     \textcolor{keywordtype}{void} \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_aa2815290e01460c161090592b803ab8a}{OnStart}}(\textcolor{keyword}{const} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_run_info}{RunInfo}} \&run,}
\DoxyCodeLine{131                  \textcolor{keyword}{const} \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_state_vector}{StateVector}} \&Y0,}
\DoxyCodeLine{132                  \textcolor{keyword}{const} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_driver_context}{DriverContext}} \&ctx) \textcolor{keyword}{override};}
\DoxyCodeLine{133 }
\DoxyCodeLine{134   \textcolor{keyword}{private}:}
\DoxyCodeLine{136     \textcolor{keywordtype}{bool} ShouldRecord(\textcolor{keywordtype}{double} t) \textcolor{keyword}{const};}
\DoxyCodeLine{137 }
\DoxyCodeLine{139     \textcolor{keywordtype}{void} Record(\textcolor{keywordtype}{double} t, \textcolor{keyword}{const} \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_state_vector}{StateVector}} \&Y, \textcolor{keyword}{const} \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_driver_context}{DriverContext}} \&ctx);}
\DoxyCodeLine{140 }
\DoxyCodeLine{142     \textcolor{keywordtype}{void} OpenOutput();}
\DoxyCodeLine{143 }
\DoxyCodeLine{144   \textcolor{keyword}{private}:}
\DoxyCodeLine{145     \mbox{\hyperlink{struct_compact_star_1_1_physics_1_1_evolution_1_1_observers_1_1_diagnostics_observer_1_1_options}{Options}} opts\_;}
\DoxyCodeLine{146 }
\DoxyCodeLine{147     std::vector<const Driver::Diagnostics::IDriverDiagnostics *> drivers\_;}
\DoxyCodeLine{148 }
\DoxyCodeLine{149     std::ofstream out\_;}
\DoxyCodeLine{150 }
\DoxyCodeLine{151     \textcolor{comment}{// Per-\/producer emission state:}}
\DoxyCodeLine{152     std::unordered\_map<std::string, std::unordered\_map<std::string, double>> last\_value\_;}
\DoxyCodeLine{153     std::unordered\_map<std::string, std::unordered\_set<std::string>> once\_emitted\_;}
\DoxyCodeLine{154 }
\DoxyCodeLine{156     \textcolor{keywordtype}{void} ApplyCadenceFilter(\mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_diagnostics_1_1_diagnostic_packet}{Diagnostics::DiagnosticPacket}} \&pkt);}
\DoxyCodeLine{157 }
\DoxyCodeLine{159     \textcolor{keyword}{static} \textcolor{keywordtype}{bool} ApproximatelyEqual(\textcolor{keywordtype}{double} a, \textcolor{keywordtype}{double} b, \textcolor{keywordtype}{double} atol, \textcolor{keywordtype}{double} rtol);}
\DoxyCodeLine{160 }
\DoxyCodeLine{161     \textcolor{comment}{// Scheduling state}}
\DoxyCodeLine{162     \textcolor{comment}{// bool first\_call\_ = true;}}
\DoxyCodeLine{163     std::size\_t step\_counter\_ = 0;   }
\DoxyCodeLine{164     \textcolor{keywordtype}{double} next\_time\_trigger\_ = 0.0; }
\DoxyCodeLine{165     \textcolor{keywordtype}{bool} started\_ = \textcolor{keyword}{false};           }
\DoxyCodeLine{166 }
\DoxyCodeLine{167     \textcolor{comment}{// Cached schema catalog for this run (built at OnStart).}}
\DoxyCodeLine{168     \mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_diagnostics_1_1_diagnostic_catalog}{Diagnostics::DiagnosticCatalog}} catalog\_;}
\DoxyCodeLine{169     \textcolor{keywordtype}{bool} catalog\_built\_ = \textcolor{keyword}{false};}
\DoxyCodeLine{170 }
\DoxyCodeLine{172     \textcolor{keywordtype}{void} ValidateAgainstCatalog(\mbox{\hyperlink{class_compact_star_1_1_physics_1_1_evolution_1_1_diagnostics_1_1_diagnostic_packet}{Diagnostics::DiagnosticPacket}} \&pkt) \textcolor{keyword}{const};}
\DoxyCodeLine{173 \};}
\DoxyCodeLine{174 }
\DoxyCodeLine{175 \} \textcolor{comment}{// namespace CompactStar::Physics::Evolution::Observers}}

\end{DoxyCode}
